#include "qrcode/info/capacity_info.h"

#include "qrcode/priv/priv_common.h"
#include "qrcode/common.h"

#include <stdint.h>

//7.4.11, table 7, pg. 38-40
static const int16_t qrcode_data_capacity_table[1056] = {
    3, 5, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,

    5, 10, 6, 0, 0,
    4, 8,  5, 0, 0,
    0, 0,  0, 0, 0,
    0, 0,  0, 0, 0,

    11, 23, 14, 9,  6,
    9,  18, 11, 7,  4,
    0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,

    16, 35, 21, 15, 9,
    14, 30, 18, 13, 8,
    10, 21, 13, 9,  5,
    0,  0,  0,  0,  0,
    
    19, 41, 25, 17, 10,
    16, 34, 20, 14, 8,
    13, 27, 16, 11, 7,
    9,  17, 10, 7,  4,
    
    34, 77, 47, 32, 20,
    28, 63, 38, 26, 16,
    22, 48, 29, 20, 12,
    16, 34, 20, 14, 8,

    55, 127, 77, 53, 32,
    44, 101, 61, 42, 26,
    34, 77,  47, 32, 20,
    26, 58,  35, 24, 15,

    80, 187, 114, 78, 48,
    64, 149, 90,  62, 38,
    48, 111, 67,  46, 28,
    36, 82,  50,  34, 21,

    108, 255, 154, 106, 65,
    86,  202, 122, 84,  52,
    62,  144, 87,  60,  37,
    46,  106, 64,  44,  27,

    136, 322, 196, 134, 82,
    108, 255, 154, 106, 65,
    76,  178, 108, 74,  45,
    60,  139, 84,  58,  36,

    156, 370, 224, 154, 95,
    124, 293, 178, 122, 75,
    88,  207, 125, 86,  53,
    66,  154, 93,  64,  39,

    194, 461, 279, 192, 118,
    154, 365, 221, 152, 93,
    110, 259, 157, 108, 66,
    86,  202, 122, 84,  52,

    232, 552, 335, 230, 141,
    182, 432, 262, 180, 111,
    132, 312, 189, 130, 80,
    100, 235, 143, 98,  60,

    274, 652, 395, 271, 167,
    216, 513, 311, 213, 131,
    154, 364, 221, 151, 93,
    122, 288, 174, 119, 74,

    324, 772, 468, 321, 198,
    254, 604, 366, 251, 155,
    180, 427, 259, 177, 109,
    140, 331, 200, 137, 85,

    370, 883, 535, 367, 226,
    290, 691, 419, 287, 177,
    206, 489, 296, 203, 125,
    158, 374, 227, 155, 96,

    428, 1022, 619, 425, 262,
    334, 796,  483, 331, 204,
    244, 580,  352, 241, 149,
    180, 427,  259, 177, 109,

    461, 1101, 667, 458, 282,
    365, 871,  528, 362, 223,
    261, 621,  376, 258, 159,
    197, 468,  283, 194, 120,

    523, 1250, 758, 520, 320,
    415, 991,  600, 412, 254,
    295, 703,  426, 292, 180,
    223, 530,  321, 220, 136,

    589, 1408, 854, 586, 361,
    453, 1082, 656, 450, 277,
    325, 755,  470, 322, 198,
    253, 602,  365, 250, 154,

    647, 1548, 938, 644, 397,
    507, 1212, 734, 504, 310,
    367, 876,  531, 364, 224,
    313, 674,  408, 280, 173,

    795, 1725, 1046, 718, 442,
    563, 1346, 816,  560, 345,
    397, 948,  574,  394, 243,
    313, 746,  452,  310, 191,

    795, 1903, 1153, 792, 488,
    627, 1500, 909,  624, 384,
    445, 1063, 644,  442, 272,
    341, 813,  493,  338, 208,

    861, 2061, 1249, 858, 528,
    669, 1600, 970,  666, 410,
    485, 1159, 702,  482, 297,
    385, 919,  557,  382, 235,
    
    932, 2232, 1352, 929, 572,
    714, 1708, 1035, 711, 438,
    512, 1224, 742,  509, 314,
    406, 969,  587,  403, 248,

    1006, 2409, 1460, 1003, 618,
    782,  1872, 1134, 779,  480,
    568,  1358, 823,  565,  348,
    442,  1056, 640,  439,  270,

    1094, 2620, 1588, 1091, 672,
    860,  2059, 1248, 857,  528,
    614,  1468, 890,  611,  376,
    464,  1108, 672,  461,  284,

    1174, 2812, 1704, 1171, 721,
    914,  2188, 1326, 911,  561,
    664,  1588, 963,  661,  407,
    514,  1228, 744,  511,  315,

    1276, 3057, 1853, 1273, 784,
    1000, 2395, 1451, 997,  614,
    718,  1718, 1041, 715,  440,
    538,  1286, 779,  535,  330,

    1370, 3283, 1990, 1367, 842,
    1062, 2544, 1542, 1059, 652,
    754,  1804, 1094, 751,  462,
    596,  1425, 864,  593,  365,

    1468, 3517, 2132, 1465, 902,
    1128, 2701, 1637, 1125, 692,
    808,  1933, 1172, 805,  496,
    628,  1501, 910,  625,  385,

    1531, 3669, 2223, 1528, 940,
    1193, 2857, 1732, 1190, 732,
    871,  2085, 1263, 868,  534,
    661,  1581, 958,  658,  405,

    1631, 3909, 2369, 1628, 1002,
    1267, 3035, 1839, 1264, 778,
    911,  2181, 1322, 908,  559,
    701,  1677, 1016, 698,  430,

    1735, 4158, 2520, 1732, 1066,
    1373, 3289, 1994, 1370, 843,
    985,  2358, 1429, 982,  604,
    745,  1782, 1080, 742,  457,

    1843, 4417, 2677, 1840, 1132,
    1455, 3486, 2113, 1452, 894,
    1033, 2473, 1499, 1030, 634,
    793,  1897, 1150, 790,  486,

    1955, 4686, 2840, 1952, 1201,
    1541, 3693, 2238, 1538, 947,
    1115, 2670, 1618, 1112, 684,
    845,  2022, 1226, 842,  518,

    2071, 4965, 3009, 2068, 1273,
    1631, 3909, 2369, 1628, 1002,
    1171, 2805, 1700, 1168, 719,
    901,  2157, 1307, 898,  553,

    2191, 5253, 3183, 2188, 1347,
    1725, 4134, 2506, 1722, 1060,
    1231, 2949, 1787, 1228, 756,
    961,  2301, 1394, 958,  590,

    2306, 5529, 3351, 2303, 1417,
    1812, 4343, 2632, 1809, 1113,
    1286, 2081, 1867, 1283, 790,
    986,  2361, 1431, 983,  605,

    2434, 5836, 3537, 2431, 1496,
    1914, 4588, 2780, 1911, 1176,
    1354, 3244, 1966, 1351, 832,
    1054, 2524, 1530, 1051, 647,

    2566, 6153, 3729, 2563, 1577,
    1992, 4775, 2894, 1989, 1223,
    1426, 3417, 2071, 1423, 876,
    1096, 2625, 1591, 1093, 673,

    2702, 6479, 3927, 2699, 1661,
    2102, 5039, 3054, 2099, 1292,
    1502, 3599, 2181, 1499, 923,
    1142, 2735, 1658, 1139, 701,

    2812, 6743, 4087, 2809, 1729,
    2216, 5313, 3220, 2219, 1362,
    1582, 3791, 2298, 1579, 972,
    1222, 2927, 1774, 1219, 750,

    2956, 7089, 4296, 2953, 1817,
    2334, 5596, 3391, 2331, 1435,
    1666, 3993, 2420, 1663, 1024,
    1276, 3057, 1852, 1273, 784
};
__attribute__((pure)) int64_t qrcode_capacity_info(int version, int ecl){
    if (!QRCODE_VALID_VERSION(version) || !QRCODE_VALID_ECL(ecl)) return -1;

    bool micro = QRCODE_VERSION_IS_MICRO(version);
    version = QRCODE_BASE_VERSION(version);
    size_t offset = 80;

    if (micro){
        if (version == 1 && ecl != QRCODE_ECL_M1) return -1;
        if (version != 1 && ecl == QRCODE_ECL_M1) return -1;
        if (ecl == QRCODE_ECL_M1) ecl = QRCODE_ECL_L;
        if (version == 2 && ecl > QRCODE_ECL_M) return -1;
        if (version == 3 && ecl > QRCODE_ECL_M) return -1;
        if (version == 4 && ecl > QRCODE_ECL_Q) return -1;
        offset = 0;
    }

    int64_t codewords    = qrcode_data_capacity_table[offset + (version - 1)*20 + (ecl - 1)*5];
    int64_t numeric      = qrcode_data_capacity_table[offset + (version - 1)*20 + (ecl - 1)*5 + 1];
    int64_t alphanumeric = qrcode_data_capacity_table[offset + (version - 1)*20 + (ecl - 1)*5 + 2];
    int64_t byte         = qrcode_data_capacity_table[offset + (version - 1)*20 + (ecl - 1)*5 + 3];
    int64_t kanji        = qrcode_data_capacity_table[offset + (version - 1)*20 + (ecl - 1)*5 + 4];

    return (codewords << 48) | (kanji << 36) | (byte << 24) | (alphanumeric << 12) | (numeric);
}